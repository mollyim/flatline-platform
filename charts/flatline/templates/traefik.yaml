{{- $componentName := "traefik" -}}
{{- $componentValues := .Values.traefikResources -}}

{{- $ctx := dict
    "Release"          .Release
    "Chart"            .Chart
    "Values"           .Values
    "Capabilities"     .Capabilities
    "Files"            .Files
    "Template"         .Template
    "componentName"    $componentName
    "componentValues"  $componentValues
-}}

{{- if $ctx.componentValues.enabled -}}

{{ template "common.secret" $ctx }}

---

{{- $hostname := (required "A valid hostname must be provided for Traefik!" $ctx.componentValues.hostname) }}
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: {{ include "common.fullnameWithComponent" $ctx }}-default
  labels:
    {{- include "common.labels" . | nindent 4 }}
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`flatline-whisper.{{ $hostname }}`)
      kind: Rule
      services:
        - name: {{ include "common.fullname" . }}-whisper-service
          port: {{ .Values.whisperService.service.ports.default.port }}
    - match: Host(`flatline-whisper-admin.{{ $hostname }}`)
      kind: Rule
      services:
        - name: {{ include "common.fullname" . }}-whisper-service
          port: {{ .Values.whisperService.service.ports.admin.port }}
    - match: Host(`flatline-storage.{{ $hostname }}`)
      kind: Rule
      services:
        - name: {{ include "common.fullname" . }}-storage-service
          port: {{ .Values.storageService.service.ports.default.port }}
    - match: Host(`flatline-storage-admin.{{ $hostname }}`)
      kind: Rule
      services:
        - name: {{ include "common.fullname" . }}-storage-service
          port: {{ .Values.storageService.service.ports.admin.port }}
    - match: Host(`flatline-cds.{{ $hostname }}`)
      kind: Rule
      services:
        - name: {{ include "common.fullname" . }}-contact-discovery-service
          port: {{ .Values.contactDiscoveryService.service.ports.default.port }}
  tls:
    secretName: {{ $ctx.componentValues.tls.secretName | default (include "common.fullnameWithComponent" $ctx) }}
    options:
      {{- if $ctx.componentValues.tls.optionsName }}
      name: {{ $ctx.componentValues.tls.optionsName }}
      {{- end }}

---

{{- if $ctx.componentValues.chart.valuesOverride }}
apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: {{ $ctx.componentValues.chart.name | default "traefik" }}
  namespace: {{ $ctx.componentValues.chart.namespace | default "kube-system" }}
spec:
  valuesContent: |-
    {{- toYaml $ctx.componentValues.chart.valuesOverride | nindent 4 }}
{{- end }}

{{- end }}
